<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>ScriptLibrary/music-containers.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-interpreter.html">Interpreter architecture</a></li><li><a href="tutorial-interpreterOutput.html">MEI output of trivial beat analysis</a></li><li><a href="tutorial-MusicEntry.html">Tinctoris Music Entry</a></li><li><a href="tutorial-siteLayouts.html">Website layouts and parts</a></li></ul><h3>Modules</h3><ul><li><a href="module-mensural-rhythm.html">mensural-rhythm</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~actOnColoration">actOnColoration</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~actOnDots">actOnDots</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~addAllStartTimes">addAllStartTimes</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~addBreveBoundariesForBlock">addBreveBoundariesForBlock</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~addStartTimesForBlock">addStartTimesForBlock</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~allUnalterableImperfectLevels">allUnalterableImperfectLevels</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~alterableLevels">alterableLevels</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~anteSim">anteSim</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~augDot">augDot</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~beatIndependentDurations">beatIndependentDurations</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~beatOfDur">beatOfDur</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~beatOfUnit">beatOfUnit</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~beatUnitStructure">beatUnitStructure</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~blockProportionMultiplier">blockProportionMultiplier</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~breveDifference">breveDifference</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~canImperfect">canImperfect</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~checkForGeneralAlteration">checkForGeneralAlteration</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~divisionDot">divisionDot</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~divisionLikeRests">divisionLikeRests</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~dupleMinimCountFromElement">dupleMinimCountFromElement</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~firstBeatAlteration">firstBeatAlteration</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~firstBeatImperfection">firstBeatImperfection</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~firstBeatImperfectionCheck">firstBeatImperfectionCheck</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~firstPerfectLevel">firstPerfectLevel</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~gcd">gcd</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~getAtomicSections">getAtomicSections</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~getEventsByMensurationForSection">getEventsByMensurationForSection</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~getLayers">getLayers</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~hasNoSections">hasNoSections</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~imperfectingLevels">imperfectingLevels</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~indexOfNextDot">indexOfNextDot</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~indexOfNextSameOrLongerOrDot">indexOfNextSameOrLongerOrDot</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~indexOfPrevLongerOrDot">indexOfPrevLongerOrDot</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~isAlterable">isAlterable</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~labelRests">labelRests</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~leveleq">leveleq</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~mensurSummary">mensurSummary</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~midBeatAlteration">midBeatAlteration</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~midBeatImperfection">midBeatImperfection</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~minimStructures">minimStructures</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~noteInt">noteInt</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~noteIntFromDur">noteIntFromDur</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~noteOrRest">noteOrRest</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~notePerfectAsWhole">notePerfectAsWhole</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~nsResolver">nsResolver</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~proportionMultiplier">proportionMultiplier</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~propProportionMultiplier">propProportionMultiplier</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~readDur">readDur</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~regularlyPerfect">regularlyPerfect</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~secondBeatAlteration">secondBeatAlteration</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~secondBeatImperfection">secondBeatImperfection</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~simpleMinims">simpleMinims</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~simplestAlterations">simplestAlterations</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~solidBlock">solidBlock</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~thirdBeatAlteration">thirdBeatAlteration</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~thirdBeatImperfection">thirdBeatImperfection</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~windowDuration">windowDuration</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~writeAlteration">writeAlteration</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~writeDur">writeDur</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~writeImperfection">writeImperfection</a></li><li data-type='method' style='display: none;'><a href="module-mensural-rhythm.html#~writeSimpleImperfection">writeSimpleImperfection</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="base.html">base</a><ul class='methods'><li data-type='method' style='display: none;'><a href="base.html#.braceStyle">braceStyle</a></li><li data-type='method' style='display: none;'><a href="base.html#.clearOneOffTags">clearOneOffTags</a></li><li data-type='method' style='display: none;'><a href="base.html#.consume">consume</a></li><li data-type='method' style='display: none;'><a href="base.html#.consumeIf">consumeIf</a></li><li data-type='method' style='display: none;'><a href="base.html#.consumeSpace">consumeSpace</a></li><li data-type='method' style='display: none;'><a href="base.html#.consumeSpace2">consumeSpace2</a></li><li data-type='method' style='display: none;'><a href="base.html#.consumeStyleTags">consumeStyleTags</a></li><li data-type='method' style='display: none;'><a href="base.html#.etcStyle">etcStyle</a></li><li data-type='method' style='display: none;'><a href="base.html#.fontCharData">fontCharData</a></li><li data-type='method' style='display: none;'><a href="base.html#.getAndSetPitch">getAndSetPitch</a></li><li data-type='method' style='display: none;'><a href="base.html#.getRhythm">getRhythm</a></li><li data-type='method' style='display: none;'><a href="base.html#.getStaffPos">getStaffPos</a></li><li data-type='method' style='display: none;'><a href="base.html#.getStaffPos2">getStaffPos2</a></li><li data-type='method' style='display: none;'><a href="base.html#.getvPos">getvPos</a></li><li data-type='method' style='display: none;'><a href="base.html#.HexChar">HexChar</a></li><li data-type='method' style='display: none;'><a href="base.html#.identity">identity</a></li><li data-type='method' style='display: none;'><a href="base.html#.isStaffPos">isStaffPos</a></li><li data-type='method' style='display: none;'><a href="base.html#.mensStyle">mensStyle</a></li><li data-type='method' style='display: none;'><a href="base.html#.metrics">metrics</a></li><li data-type='method' style='display: none;'><a href="base.html#.musicFont">musicFont</a></li><li data-type='method' style='display: none;'><a href="base.html#.musicStyle">musicStyle</a></li><li data-type='method' style='display: none;'><a href="base.html#.pitchgt">pitchgt</a></li><li data-type='method' style='display: none;'><a href="base.html#.restFont">restFont</a></li><li data-type='method' style='display: none;'><a href="base.html#.restStyle">restStyle</a></li><li data-type='method' style='display: none;'><a href="base.html#.sansFont">sansFont</a></li><li data-type='method' style='display: none;'><a href="base.html#.setDotPos">setDotPos</a></li><li data-type='method' style='display: none;'><a href="base.html#.staffPosFromPitchString">staffPosFromPitchString</a></li><li data-type='method' style='display: none;'><a href="base.html#.staffPosFromString">staffPosFromString</a></li><li data-type='method' style='display: none;'><a href="base.html#.staffPosition">staffPosition</a></li><li data-type='method' style='display: none;'><a href="base.html#.starFont">starFont</a></li><li data-type='method' style='display: none;'><a href="base.html#.textClasses">textClasses</a></li><li data-type='method' style='display: none;'><a href="base.html#.textFont">textFont</a></li><li data-type='method' style='display: none;'><a href="base.html#.texty">texty</a></li><li data-type='method' style='display: none;'><a href="base.html#.unRead">unRead</a></li><li data-type='method' style='display: none;'><a href="base.html#.yoffset">yoffset</a></li><li data-type='method' style='display: none;'><a href="base.html#.yPos">yPos</a></li><li data-type='method' style='display: none;'><a href="base.html#.zerofunction">zerofunction</a></li></ul></li><li><a href="base_drawing.html">base/drawing</a><ul class='methods'><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawBarline">drawBarline</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawBox">drawBox</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawChantBox">drawChantBox</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawLedgerLine">drawLedgerLine</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawMensurStrich">drawMensurStrich</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawNeumeJoin">drawNeumeJoin</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawOblique">drawOblique</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawOblique2">drawOblique2</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawObliqueEnd">drawObliqueEnd</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawObliqueNeume">drawObliqueNeume</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawObliqueStart">drawObliqueStart</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawPartialBarline">drawPartialBarline</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawRedBarline">drawRedBarline</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawRhombus">drawRhombus</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawRichText">drawRichText</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawScallopedBarline">drawScallopedBarline</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawSmallBarline">drawSmallBarline</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawSystem">drawSystem</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawSystemLines">drawSystemLines</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.drawVerticalLine">drawVerticalLine</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.neumeStep">neumeStep</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.oWidth">oWidth</a></li><li data-type='method' style='display: none;'><a href="base_drawing.html#.squareBracket">squareBracket</a></li></ul></li><li><a href="base_parsing.html">base/parsing</a><ul class='methods'><li data-type='method' style='display: none;'><a href="base_parsing.html#.bracedParam">bracedParam</a></li></ul></li><li><a href="base_queryHelper.html">base/queryHelper</a><ul class='methods'><li data-type='method' style='display: none;'><a href="base_queryHelper.html#.getDefaultReading">getDefaultReading</a></li><li data-type='method' style='display: none;'><a href="base_queryHelper.html#.getDefaultText">getDefaultText</a></li></ul></li><li><a href="base_sysbreak.html">base/sysbreak</a><ul class='methods'><li data-type='method' style='display: none;'><a href="base_sysbreak.html#.nextPitch">nextPitch</a></li><li data-type='method' style='display: none;'><a href="base_sysbreak.html#.pitchAndPos">pitchAndPos</a></li><li data-type='method' style='display: none;'><a href="base_sysbreak.html#.sysBreak">sysBreak</a></li><li data-type='method' style='display: none;'><a href="base_sysbreak.html#.sysBreak2">sysBreak2</a></li></ul></li><li><a href="classes.html">classes</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.html#.classString">classString</a></li><li data-type='method' style='display: none;'><a href="classes.html#.drawClasses">drawClasses</a></li><li data-type='method' style='display: none;'><a href="classes.html#.isResolved">isResolved</a></li><li data-type='method' style='display: none;'><a href="classes.html#.removeRedlineBefore">removeRedlineBefore</a></li><li data-type='method' style='display: none;'><a href="classes.html#.witnessReading">witnessReading</a></li></ul></li><li><a href="editor.html">editor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="editor.html#.adjustWidth">adjustWidth</a></li><li data-type='method' style='display: none;'><a href="editor.html#.refreshFromCode">refreshFromCode</a></li><li data-type='method' style='display: none;'><a href="editor.html#.setSpacing">setSpacing</a></li><li data-type='method' style='display: none;'><a href="editor.html#.toggleWrapping">toggleWrapping</a></li></ul></li><li><a href="editor_music_editbase.html">editor/music/editbase</a><ul class='methods'><li data-type='method' style='display: none;'><a href="editor_music_editbase.html#.editObject">editObject</a></li><li data-type='method' style='display: none;'><a href="editor_music_editbase.html#.grabdomobjects">grabdomobjects</a></li><li data-type='method' style='display: none;'><a href="editor_music_editbase.html#.hoverOutShiftChecked">hoverOutShiftChecked</a></li><li data-type='method' style='display: none;'><a href="editor_music_editbase.html#.pitchOrHeightShift">pitchOrHeightShift</a></li><li data-type='method' style='display: none;'><a href="editor_music_editbase.html#.shiftHoverToShift">shiftHoverToShift</a></li><li data-type='method' style='display: none;'><a href="editor_music_editbase.html#.UpDown">UpDown</a></li></ul></li><li><a href="getMusic.html">getMusic</a><ul class='methods'><li data-type='method' style='display: none;'><a href="getMusic.html#.getParam">getParam</a></li><li data-type='method' style='display: none;'><a href="getMusic.html#.grabFromFile">grabFromFile</a></li><li data-type='method' style='display: none;'><a href="getMusic.html#.loadData">loadData</a></li><li data-type='method' style='display: none;'><a href="getMusic.html#.loadSubMenu">loadSubMenu</a></li></ul></li><li><a href="music-container.html">music-container</a></li><li><a href="music-parser.html">music-parser</a><ul class='methods'><li data-type='method' style='display: none;'><a href="music-parser.html#.colourp">colourp</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.consumeParenthesis">consumeParenthesis</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.enrichText">enrichText</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.extendTacet">extendTacet</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.getMusicTextSup">getMusicTextSup</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.getParameters">getParameters</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.getString">getString</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.getSubText">getSubText</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.getTag">getTag</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.linesp">linesp</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextBarline">nextBarline</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextChantNote">nextChantNote</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextChoice">nextChoice</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextChoiceLikeThing">nextChoiceLikeThing</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextChoiceLikeThing2">nextChoiceLikeThing2</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextColRef">nextColRef</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextComment">nextComment</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextCustos">nextCustos</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextDot">nextDot</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextEvent">nextEvent</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextFermata">nextFermata</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextInfo">nextInfo</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextLigature">nextLigature</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextLigChoice">nextLigChoice</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextLongRest">nextLongRest</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextMusicIteratesthroughthestringandparsesmusicaleventsorenrichesotherevents">nextMusicIterates through the string and parses musical events or enriches other events</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextNeume">nextNeume</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextNote">nextNote</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextOblique">nextOblique</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextObliqueNeume">nextObliqueNeume</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextObliqueNoteChoice">nextObliqueNoteChoice</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextPart">nextPart</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextPartnameReading">nextPartnameReading</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextRepeat">nextRepeat</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextRest">nextRest</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextSignumCongruentiae">nextSignumCongruentiae</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextSolmSign">nextSolmSign</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextTacet">nextTacet</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextTaglike">nextTaglike</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextText">nextText</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.nextTextChoice">nextTextChoice</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseClef">parseClef</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseClefReading">parseClefReading</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseClefVar">parseClefVar</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseMens">parseMens</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseMensReading">parseMensReading</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseMensReading">parseMensReading</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseProp">parseProp</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseSolm">parseSolm</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseSolmReading">parseSolmReading</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseSolmVar">parseSolmVar</a></li><li data-type='method' style='display: none;'><a href="music-parser.html#.parseStaff">parseStaff</a></li></ul></li><li><a href="parser.html">parser</a></li><li><a href="SVGfunctions.html">SVGfunctions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.clearSVG">clearSVG</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svg">svg</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgArc">svgArc</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgCircle">svgCircle</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgCSS">svgCSS</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgGroup">svgGroup</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgLine">svgLine</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgPath">svgPath</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgPolygon">svgPolygon</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgPolyPath">svgPolyPath</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgRect">svgRect</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgSpan">svgSpan</a></li><li data-type='method' style='display: none;'><a href="SVGfunctions.html#.svgText">svgText</a></li></ul></li><li><a href="tei-classes.html">tei-classes</a></li></ul><h3>Classes</h3><ul><li><a href="base.docMapping.html">docMapping</a></li><li><a href="classes.Barline.html">Barline</a></li><li><a href="classes.BlueClose.html">BlueClose</a></li><li><a href="classes.BlueOpen.html">BlueOpen</a></li><li><a href="classes.ChantNote.html">ChantNote</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.ChantNote.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.ChantNote.html#edit">edit</a></li><li data-type='method' style='display: none;'><a href="classes.ChantNote.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="classes.ChantNote.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="classes.ChantNote.html#width">width</a></li></ul></li><li><a href="classes.Classes.html">Classes</a></li><li><a href="classes.Clef.html">Clef</a></li><li><a href="classes.ColumnStart.html">ColumnStart</a></li><li><a href="classes.Comment.html">Comment</a></li><li><a href="classes.Custos.html">Custos</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.Custos.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.Custos.html#MEINode">MEINode</a></li><li data-type='method' style='display: none;'><a href="classes.Custos.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="classes.Custos.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="classes.Custos.html#width">width</a></li></ul></li><li><a href="classes.Dot.html">Dot</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.Dot.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.Dot.html#negativeSpace">negativeSpace</a></li><li data-type='method' style='display: none;'><a href="classes.Dot.html#reallyAugments">reallyAugments</a></li><li data-type='method' style='display: none;'><a href="classes.Dot.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="classes.Dot.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="classes.Dot.html#width">width</a></li></ul></li><li><a href="classes.etc.html">etc</a></li><li><a href="classes.ExampleBreak.html">ExampleBreak</a></li><li><a href="classes.Fermata.html">Fermata</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.Fermata.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.Fermata.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="classes.Fermata.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="classes.Fermata.html#width">width</a></li></ul></li><li><a href="classes.FullClose.html">FullClose</a></li><li><a href="classes.FullOpen.html">FullOpen</a></li><li><a href="classes.GenericClose.html">GenericClose</a></li><li><a href="classes.GenericOpen.html">GenericOpen</a></li><li><a href="classes.HalfFullClose.html">HalfFullClose</a></li><li><a href="classes.HalfFullOpen.html">HalfFullOpen</a></li><li><a href="classes.LargeClose.html">LargeClose</a></li><li><a href="classes.LargeOpen.html">LargeOpen</a></li><li><a href="classes.LedgerLineChange.html">LedgerLineChange</a></li><li><a href="classes.Ligature.html">Ligature</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.Ligature.html#addChoice">addChoice</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#addElement">addElement</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#addEvent">addEvent</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#addNote">addNote</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#addOblique">addOblique</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#drawVar">drawVar</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#enrichEvent">enrichEvent</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#firstEvent">firstEvent</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#firstNoteIndexp">firstNoteIndexp</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#lastNoteIndexp">lastNoteIndexp</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#leftOverhang">leftOverhang</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#negativeSpace">negativeSpace</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#nextNote">nextNote</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#nextPos">nextPos</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#nthNote">nthNote</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#oblique">oblique</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#prevNote">prevNote</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#prevPos">prevPos</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#varEndStaffPos">varEndStaffPos</a></li><li data-type='method' style='display: none;'><a href="classes.Ligature.html#width">width</a></li></ul></li><li><a href="classes.LigatureComment.html">LigatureComment</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.LigatureComment.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureComment.html#drawVar">drawVar</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureComment.html#footnote">footnote</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureComment.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureComment.html#toText">toText</a></li></ul></li><li><a href="classes.LigatureNote.html">LigatureNote</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#backwardEvent">backwardEvent</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#drawVar">drawVar</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#forwardEvent">forwardEvent</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#lstem">lstem</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#nextEvent">nextEvent</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#prevEvent">prevEvent</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#rstem">rstem</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#varEndStaffPos">varEndStaffPos</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#varStartStaffPos">varStartStaffPos</a></li><li data-type='method' style='display: none;'><a href="classes.LigatureNote.html#width">width</a></li></ul></li><li><a href="classes.LigChoice.html">LigChoice</a></li><li><a href="classes.Linebreak.html">Linebreak</a></li><li><a href="classes.LongRest.html">LongRest</a></li><li><a href="classes.MaxRest.html">MaxRest</a></li><li><a href="classes.MChoice.html">MChoice</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.MChoice.html#addNilReading">addNilReading</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#addOmission">addOmission</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#addParams">addParams</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#addReading">addReading</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#addTextReading">addTextReading</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#applicableReading">applicableReading</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#clefp">clefp</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#hasPart">hasPart</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#ignorable">ignorable</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#infop">infop</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#nonDefault">nonDefault</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#overPrevious">overPrevious</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#solmp">solmp</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#tip">tip</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#updateStyles">updateStyles</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#varEndStaffPos">varEndStaffPos</a></li><li data-type='method' style='display: none;'><a href="classes.MChoice.html#width">width</a></li></ul></li><li><a href="classes.MensuralSignature.html">MensuralSignature</a></li><li><a href="classes.MESuper.html">MESuper</a></li><li><a href="classes.MNilReading.html">MNilReading</a></li><li><a href="classes.MOmission.html">MOmission</a></li><li><a href="classes.MReading.html">MReading</a></li><li><a href="classes.MusicOptionalSpace.html">MusicOptionalSpace</a></li><li><a href="classes.MusicPunctuation.html">MusicPunctuation</a></li><li><a href="classes.MusicWordJoin.html">MusicWordJoin</a></li><li><a href="classes.MusicWordSplit.html">MusicWordSplit</a></li><li><a href="classes.NegativeSpace.html">NegativeSpace</a></li><li><a href="classes.Neume.html">Neume</a></li><li><a href="classes.NeumeItem.html">NeumeItem</a></li><li><a href="classes.Notation.html">Notation</a></li><li><a href="classes.Note.html">Note</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.Note.html#commentPos">commentPos</a></li><li data-type='method' style='display: none;'><a href="classes.Note.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.Note.html#edit">edit</a></li><li data-type='method' style='display: none;'><a href="classes.Note.html#negativeSpace">negativeSpace</a></li><li data-type='method' style='display: none;'><a href="classes.Note.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="classes.Note.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="classes.Note.html#width">width</a></li></ul></li><li><a href="classes.Oblique.html">Oblique</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.Oblique.html#backwardEvent">backwardEvent</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#drawComments">drawComments</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#drawTexts">drawTexts</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#drawVar">drawVar</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#enrichEvent">enrichEvent</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#extendMembers">extendMembers</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#flattenedMembers">flattenedMembers</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#forwardEvent">forwardEvent</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#lstem">lstem</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#member">member</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#nextEvent">nextEvent</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#prevEvent">prevEvent</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#rstem">rstem</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#width">width</a></li><li data-type='method' style='display: none;'><a href="classes.Oblique.html#width">width</a></li></ul></li><li><a href="classes.ObliqueNeume.html">ObliqueNeume</a></li><li><a href="classes.ObliqueNote.html">ObliqueNote</a></li><li><a href="classes.ObliqueNoteChoice.html">ObliqueNoteChoice</a></li><li><a href="classes.Parameters.html">Parameters</a></li><li><a href="classes.Part.html">Part</a></li><li><a href="classes.PositiveSpace.html">PositiveSpace</a></li><li><a href="classes.ProportionSign.html">ProportionSign</a></li><li><a href="classes.RedClose.html">RedClose</a></li><li><a href="classes.RedlineClose.html">RedlineClose</a></li><li><a href="classes.RedlineOpen.html">RedlineOpen</a></li><li><a href="classes.RedOpen.html">RedOpen</a></li><li><a href="classes.Repeat.html">Repeat</a></li><li><a href="classes.Rest.html">Rest</a></li><li><a href="classes.SignumCongruentiae.html">SignumCongruentiae</a><ul class='methods'><li data-type='method' style='display: none;'><a href="classes.SignumCongruentiae.html#backwardEvent">backwardEvent</a></li><li data-type='method' style='display: none;'><a href="classes.SignumCongruentiae.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="classes.SignumCongruentiae.html#forwardEvent">forwardEvent</a></li><li data-type='method' style='display: none;'><a href="classes.SignumCongruentiae.html#nextEvent">nextEvent</a></li><li data-type='method' style='display: none;'><a href="classes.SignumCongruentiae.html#prevEvent">prevEvent</a></li><li data-type='method' style='display: none;'><a href="classes.SignumCongruentiae.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="classes.SignumCongruentiae.html#varEndStaffPos">varEndStaffPos</a></li><li data-type='method' style='display: none;'><a href="classes.SignumCongruentiae.html#varStartStaffPos">varStartStaffPos</a></li></ul></li><li><a href="classes.SolmizationSign.html">SolmizationSign</a></li><li><a href="classes.SolmizationSignature.html">SolmizationSignature</a></li><li><a href="classes.StackedProportionSigns.html">StackedProportionSigns</a></li><li><a href="classes.Staff.html">Staff</a></li><li><a href="classes.StrikethroughClose.html">StrikethroughClose</a></li><li><a href="classes.StrikethroughOpen.html">StrikethroughOpen</a></li><li><a href="classes.Tacet.html">Tacet</a></li><li><a href="classes.TextUnderlay.html">TextUnderlay</a></li><li><a href="classes.upsideDownClose.html">upsideDownClose</a></li><li><a href="classes.upsideDownOpen.html">upsideDownOpen</a></li><li><a href="classes.ValueChoice.html">ValueChoice</a></li><li><a href="classes.ValueReading.html">ValueReading</a></li><li><a href="classes.VoidClose.html">VoidClose</a></li><li><a href="classes.VoidOpen.html">VoidOpen</a></li><li><a href="music-container.MusicExample.html">MusicExample</a><ul class='methods'><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#appendStaffDefs">appendStaffDefs</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#commentsDiv">commentsDiv</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#commentsTip">commentsTip</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#easyRhythms">easyRhythms</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#gatherStaffs">gatherStaffs</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#height">height</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#markResolved">markResolved</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#mensurStrich">mensurStrich</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#parse">parse</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#regenerateMEILinks">regenerateMEILinks</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#reset">reset</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#setSysWidths">setSysWidths</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#staffDefForPart">staffDefForPart</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#startingStaffForPart">startingStaffForPart</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#stupidVerovioStretch">stupidVerovioStretch</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#targetWidth">targetWidth</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#toTEI">toTEI</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#toText">toText</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicExample.html#width">width</a></li></ul></li><li><a href="music-container.MusicHolder.html">MusicHolder</a><ul class='methods'><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#appendStaffDefs">appendStaffDefs</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#draw">draw</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#headerText">headerText</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#infoButton">infoButton</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#infoButtons">infoButtons</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#parse">parse</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#parseHeaders">parseHeaders</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#staffDefForPart">staffDefForPart</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#toMEI">toMEI</a></li><li data-type='method' style='display: none;'><a href="music-container.MusicHolder.html#writeHeaders">writeHeaders</a></li></ul></li><li><a href="tei-classes.MEIDoc.html">MEIDoc</a></li><li><a href="tei-classes.TEIDoc.html">TEIDoc</a></li></ul>undefined<h3>Global</h3><ul><li><a href="global.html#allowCapitalisation">allowCapitalisation</a></li><li><a href="global.html#allTexts">allTexts</a></li><li><a href="global.html#baseDictionary">baseDictionary</a></li><li><a href="global.html#book">book</a></li><li><a href="global.html#braceOff">braceOff</a></li><li><a href="global.html#canvas">canvas</a></li><li><a href="global.html#capitalise">capitalise</a></li><li><a href="global.html#chapter">chapter</a></li><li><a href="global.html#clefDictionary">clefDictionary</a></li><li><a href="global.html#clefOffsets">clefOffsets</a></li><li><a href="global.html#colours">colours</a></li><li><a href="global.html#commentary">commentary</a></li><li><a href="global.html#commentaryTables">commentaryTables</a></li><li><a href="global.html#comments">comments</a></li><li><a href="global.html#commentStyle">commentStyle</a></li><li><a href="global.html#complaint">complaint</a></li><li><a href="global.html#compoundNotep">compoundNotep</a></li><li><a href="global.html#context">context</a></li><li><a href="global.html#copyTextDisplay">copyTextDisplay</a></li><li><a href="global.html#curCatchword">curCatchword</a></li><li><a href="global.html#curDoc">curDoc</a></li><li><a href="global.html#currentChoice">currentChoice</a></li><li><a href="global.html#currentClef">currentClef</a></li><li><a href="global.html#currentExample">currentExample</a></li><li><a href="global.html#currentInfo">currentInfo</a></li><li><a href="global.html#currentLinecount">currentLinecount</a></li><li><a href="global.html#currentReading">currentReading</a></li><li><a href="global.html#currentRedline">currentRedline</a></li><li><a href="global.html#currentSolm">currentSolm</a></li><li><a href="global.html#currentStaffColour">currentStaffColour</a></li><li><a href="global.html#currentSubType">currentSubType</a></li><li><a href="global.html#currentSystem">currentSystem</a></li><li><a href="global.html#currentSystems">currentSystems</a></li><li><a href="global.html#currentTable">currentTable</a></li><li><a href="global.html#currentTextParent">currentTextParent</a></li><li><a href="global.html#currenttextparent">currenttextparent</a></li><li><a href="global.html#currentType">currentType</a></li><li><a href="global.html#curtextitem">curtextitem</a></li><li><a href="global.html#curx">curx</a></li><li><a href="global.html#cury">cury</a></li><li><a href="global.html#dateDisplay">dateDisplay</a></li><li><a href="global.html#debug">debug</a></li><li><a href="global.html#defaultColour">defaultColour</a></li><li><a href="global.html#desperatecounter">desperatecounter</a></li><li><a href="global.html#doc">doc</a></li><li><a href="global.html#docMap">docMap</a></li><li><a href="global.html#dotData">dotData</a></li><li><a href="global.html#dotNudge">dotNudge</a></li><li><a href="global.html#dotPos">dotPos</a></li><li><a href="global.html#drawingWidth">drawingWidth</a></li><li><a href="global.html#editable">editable</a></li><li><a href="global.html#editorDisplay">editorDisplay</a></li><li><a href="global.html#editorMode">editorMode</a></li><li><a href="global.html#eventi">eventi</a></li><li><a href="global.html#examplei">examplei</a></li><li><a href="global.html#exampleno">exampleno</a></li><li><a href="global.html#examples">examples</a></li><li><a href="global.html#exampleSource">exampleSource</a></li><li><a href="global.html#extraInfoDisplay">extraInfoDisplay</a></li><li><a href="global.html#exWidth">exWidth</a></li><li><a href="global.html#fermataData">fermataData</a></li><li><a href="global.html#findPopupPos">findPopupPos</a></li><li><a href="global.html#flattenOnExport">flattenOnExport</a></li><li><a href="global.html#flippedDictionary">flippedDictionary</a></li><li><a href="global.html#foo">foo</a></li><li><a href="global.html#goesOverScreenEnd">goesOverScreenEnd</a></li><li><a href="global.html#hackedString">hackedString</a></li><li><a href="global.html#hands">hands</a></li><li><a href="global.html#handsmet">handsmet</a></li><li><a href="global.html#hang">hang</a></li><li><a href="global.html#inCommentary">inCommentary</a></li><li><a href="global.html#infoButtons">infoButtons</a></li><li><a href="global.html#infoDisplay">infoDisplay</a></li><li><a href="global.html#inHeading">inHeading</a></li><li><a href="global.html#inIndex">inIndex</a></li><li><a href="global.html#initialStaffStar">initialStaffStar</a></li><li><a href="global.html#inTip">inTip</a></li><li><a href="global.html#inVerse">inVerse</a></li><li><a href="global.html#k1">k1</a></li><li><a href="global.html#k2">k2</a></li><li><a href="global.html#lastIsHeading">lastIsHeading</a></li><li><a href="global.html#lastIsSentenceBreak">lastIsSentenceBreak</a></li><li><a href="global.html#lastIsVerse">lastIsVerse</a></li><li><a href="global.html#leading">leading</a></li><li><a href="global.html#leaveSpace">leaveSpace</a></li><li><a href="global.html#lmargin">lmargin</a></li><li><a href="global.html#localWidth">localWidth</a></li><li><a href="global.html#lowPoint">lowPoint</a></li><li><a href="global.html#margins">margins</a></li><li><a href="global.html#maxWidth">maxWidth</a></li><li><a href="global.html#MEILinks">MEILinks</a></li><li><a href="global.html#mensDictionary">mensDictionary</a></li><li><a href="global.html#minWidth">minWidth</a></li><li><a href="global.html#musicMap">musicMap</a></li><li><a href="global.html#neumeForms">neumeForms</a></li><li><a href="global.html#noBreaks">noBreaks</a></li><li><a href="global.html#nocache">nocache</a></li><li><a href="global.html#noCount">noCount</a></li><li><a href="global.html#nodeNo">nodeNo</a></li><li><a href="global.html#nodes">nodes</a></li><li><a href="global.html#noteEn">noteEn</a></li><li><a href="global.html#notes">notes</a></li><li><a href="global.html#oneOff">oneOff</a></li><li><a href="global.html#paneWidths">paneWidths</a></li><li><a href="global.html#paragraph">paragraph</a></li><li><a href="global.html#pari">pari</a></li><li><a href="global.html#pointer">pointer</a></li><li><a href="global.html#prevBook">prevBook</a></li><li><a href="global.html#prop">prop</a></li><li><a href="global.html#punctuationStyle">punctuationStyle</a></li><li><a href="global.html#range">range</a></li><li><a href="global.html#rastralSize">rastralSize</a></li><li><a href="global.html#redline">redline</a></li><li><a href="global.html#restDictionary">restDictionary</a></li><li><a href="global.html#rhythms">rhythms</a></li><li><a href="global.html#safari">safari</a></li><li><a href="global.html#scrollLock">scrollLock</a></li><li><a href="global.html#section">section</a></li><li><a href="global.html#sentence">sentence</a></li><li><a href="global.html#showagain">showagain</a></li><li><a href="global.html#showcommentary">showcommentary</a></li><li><a href="global.html#showfacsimile">showfacsimile</a></li><li><a href="global.html#showtitle">showtitle</a></li><li><a href="global.html#showtranscriptionnotes">showtranscriptionnotes</a></li><li><a href="global.html#showtranslationnotes">showtranslationnotes</a></li><li><a href="global.html#showvariants">showvariants</a></li><li><a href="global.html#singlePaneMode">singlePaneMode</a></li><li><a href="global.html#solmDictionary">solmDictionary</a></li><li><a href="global.html#sourceDisplay">sourceDisplay</a></li><li><a href="global.html#sources">sources</a></li><li><a href="global.html#staffGroup">staffGroup</a></li><li><a href="global.html#standaloneEditor">standaloneEditor</a></li><li><a href="global.html#state">state</a></li><li><a href="global.html#strikeStarts">strikeStarts</a></li><li><a href="global.html#string">string</a></li><li><a href="global.html#suppressBreak">suppressBreak</a></li><li><a href="global.html#SVG">SVG</a></li><li><a href="global.html#sysNo">sysNo</a></li><li><a href="global.html#systemContainsPageOrColumnBreak">systemContainsPageOrColumnBreak</a></li><li><a href="global.html#systemLines">systemLines</a></li><li><a href="global.html#sysWidths">sysWidths</a></li><li><a href="global.html#texti">texti</a></li><li><a href="global.html#textnodes">textnodes</a></li><li><a href="global.html#texts">texts</a></li><li><a href="global.html#textScale">textScale</a></li><li><a href="global.html#timeouts">timeouts</a></li><li><a href="global.html#titleBar">titleBar</a></li><li><a href="global.html#topMargin">topMargin</a></li><li><a href="global.html#uncapitalise">uncapitalise</a></li><li><a href="global.html#underlays">underlays</a></li><li><a href="global.html#vertical">vertical</a></li><li><a href="global.html#voidBaseDictionary">voidBaseDictionary</a></li><li><a href="global.html#voidFlippedDictionary">voidFlippedDictionary</a></li><li><a href="global.html#voidnotes">voidnotes</a></li><li><a href="global.html#webkit">webkit</a></li><li><a href="global.html#wrapWidth">wrapWidth</a></li><li><a href="global.html#ya">ya</a></li><li><a href="global.html#yb">yb</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">ScriptLibrary/music-containers.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Contains container classes for music, like MusicHolder and MusicExample
 * @namespace music-container
 */

 /** @class
 * @memberof music-container
 */
function MusicHolder(text, outdiv){
    /** @property {MusicHolder} */
    this.text = text;
    /** @property {MusicHolder} */
    this.prevWidth = false;
    /** @property {MusicHolder} */
    this.forceredraw = true;
    /** @property {MusicHolder} */
    this.footnotes = [];
    /** @property {MusicHolder} */
    this.example = false;
    /** @property {MusicHolder} */
    this.out = outdiv ? outdiv : document.getElementById('content');
    /** @property {MusicHolder} */
    this.drawTo = this.out;
    /** @property {MusicHolder} */
    this.drawTo.classList.add("drawTo");
    /** @property {MusicHolder} */
    this.entered = false;
    /** @property {MusicHolder} */
    this.shortTitle = false;
    /** @property {MusicHolder} */
    this.checked = false;
    /** @property {MusicHolder} */
    this.approved = false;
    /** @property {MusicHolder} */
    this.translator = false;
    /** @property {MusicHolder} */
    this.contents = [];
    /** @property {MusicHolder} */
    this.copy = false;
    /** @property {MusicHolder} */
    this.source = false;
    /** @property {MusicHolder} */
    this.established = false;
    /** @property {MusicHolder} */
    this.basefile = false;
    /** @property {MusicHolder} */
    this.basefiles = false;
    /** @property {MusicHolder} */
    this.source = false;
    /** @property {MusicHolder} */
    this.title = false;
    /** @property {MusicHolder} */
    this.attribution = false;
    /** @property {MusicHolder} */
    this.sources = [];
    /** @property {MusicHolder} */
    this.running = false;
    /** @property {MusicHolder} */
    this.scriptSpec = false;
    /** @property {MusicHolder} */
    this.script = false;
    /** @property {MusicHolder} */
    this.editor = false;
    /** @property {MusicHolder} */
    this.columns = false;
    /** @property {MusicHolder} */
    this.hands = [];
    /** @property {MusicHolder} */
    this.UUIDs = {};
    /** infoButton
     * @summary infoButtons (qv) presents several buttons for different bits of info.
     */
      this.infoButton = function(){
      // this.infoButtons (qv) presents several buttons for different bits of
      // info. Let's try a less complex approach -- just one button
      var ib = this.drawTo.appendChild(DOMDiv('infoButtons'), false, false);
      infoButton("i", ["editor", "checkedby", "enteredby", "approvedby","dateestablished",
                       "source", "sources", "translator", "copytext","script", "columns", "running"], 
                 ib, infoDisplay == "show", "infoDisplay");
    };
    /** infoButton */
    this.infoButtons = function(){
      var ib = this.drawTo.appendChild(DOMDiv('infoButtons'), false, false);
      if(this.editor || this.entered || this.checked || this.approved){
        if(editorDisplay == "show" || editorDisplay == "hide"){
          infoButton("e", ["editor", "checkedby", "enteredby", "approvedby"], ib,
            editorDisplay == "show", "editorDisplay");
        }
      }
      if(this.established){
        if(dateDisplay == "show" || dateDisplay == "hide"){
          infoButton("d", ["dateestablished"], ib,
            dateDisplay == "show", "dateDisplay");
        }
      }
      if(this.source || this.sources.length){
        if(sourceDisplay == "show" || sourceDisplay == "hide"){
          infoButton("s", ["source", "sources"], ib,
            sourceDisplay == "show", "sourceDisplay");
        }
      }
      if(this.copy){
        if(copyTextDisplay == "show" || copyTextDisplay == "hide"){
          infoButton("c", ["copytext"], ib,
          copyTextDisplay == "show", "copyTextDisplay");
        }
      }
      if(this.running){
        if(extraInfoDisplay == "show" || extraInfoDisplay == "hide"){
          infoButton("+", ["script", "columns", "running"], ib,
          copyTextDisplay == "show", "extraInfoDisplay");
        }
      }
    };
    /** writeHeaders to content */
    this.writeHeaders = function(){
      if(this.title &amp;&amp; showtitle){
        this.drawTo.appendChild(DOMTextEl("h2", "title", false, this.title));
      }
      if(this.attribution &amp;&amp; showtitle)
      {
        this.drawTo.appendChild(DOMTextEl("hi", "attribution", false, this.attribution));
      }
      if(infoButtons){
        // this.infoButtons();
        this.infoButton();
      }
      if(this.translator){
        this.drawTo.appendChild(fieldDatumPair("Translator", this.translator));
        if(editorDisplay == "hide" || !editorDisplay) $(".info.translator").hide();
      }
      if(this.editor){
        this.drawTo.appendChild(fieldDatumPair("Editor", this.editor));
        if(editorDisplay == "hide" || !editorDisplay) $(".info.editor").hide();
      }
      if(this.entered){
        this.drawTo.appendChild(fieldDatumPair("Entered by", this.entered));
        if(editorDisplay == "hide" || !editorDisplay) $(".info.enteredby").hide();
      }
      if(this.checked){
        this.drawTo.appendChild(fieldDatumPair("Checked by", this.checked));
        if(editorDisplay == "hide" || !editorDisplay) $(".info.checkedby").hide();
      }
      if(this.established){
        this.drawTo.appendChild(fieldDatumPair("Date established", this.established));
        if(dateDisplay == "hide" || !dateDisplay) $(".info.dateestablished").hide();
      }
      if(this.approved){
        this.drawTo.appendChild(fieldDatumPair("Approved by", this.approved));
        if(editorDisplay == "hide" || !editorDisplay) $(".info.approvedby").hide();
      }
      if(this.copy){
        this.drawTo.appendChild(fieldDatumPair("Copy text", this.copy));
        if(copyTextDisplay == "hide" || !copyTextDisplay) $(".info.copytext").hide();
      }
      if(this.source){
        this.drawTo.appendChild(fieldDatumPair("Source", this.source));
        if(sourceDisplay == "hide" || !sourceDisplay) $(".info.source").hide();
      }
      if(this.script){
        this.drawTo.appendChild(fieldDatumPair("Script", this.script));
        if(extraInfoDisplay == "hide" || !extraInfoDisplay) $(".info.script").hide();
      }
      if(this.columns){
        this.drawTo.appendChild(fieldDatumPair("Columns", ""+this.columns));
        if(extraInfoDisplay == "hide" || !extraInfoDisplay) $(".info.columns").hide();
      }
      if(this.running){
        this.drawTo.appendChild(fieldDatumPair("Running", this.running));
        if(extraInfoDisplay == "hide" || !extraInfoDisplay) $(".info.running").hide();
      }
      if(this.sources.length){
        var div = DOMDiv('info sources', false, false);
        div.appendChild(DOMSpan('fieldname', false, "Sources: "));
        for (var i=0; i&lt;this.sources.length; i++){
          div.appendChild(this.sources[i].toHTML());
        }
        this.drawTo.appendChild(div);
        if(sourceDisplay == "hide" || !sourceDisplay) $(".info.sources").hide();
      }
    };
    /** parseHeaders from codeDiv(?) */
    this.parseHeaders = function(){
          // Check if there's either just one line or no textual content
          // before a &lt;piece pseudo-element
      if(!/[\r\n][^\r\n]+/.exec(string) || /^[^a-zA-Z]*&lt;piece/.exec(string)) {
        // Just one line. Assume it's content
              console.log("No header found in ", string);
        return;
      }
          // FIXME: will this be a problem for titles with Colons?
          consumeSpace();
          var title = consumeIf(/[^\r\n:]*[\r\n]/)
      if(title) {
              this.title = trimString(title);
              consumeSpace();
              var attribution = consumeIf(/[^\r\n:]*[\r\n]/)
              if(attribution) this.attribution = trimString(attribution);
          }
      consumeSpace();
      var nextfield=consumeIf(/[^:]*:/);
      while(nextfield){
        switch (nextfield){
          case "Data entry:":
            this.entered = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Short-title:":
            this.shortTitle = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Checked by:":
            this.checked = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Approved by:":
            this.approved = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Translator:":
            this.translator = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Copy-text:":
            this.basefile = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Base file:":
            this.basefile = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Base transcription:":
            this.basefile = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Base files:":
            this.basefiles = trimString(consumeIf(/[^\r\n]*[\r\n]*/)).split(", ");
            break;
          case "Editor:":
            this.editor = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Source:":
            this.source = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Script:":
            this.scriptSpec = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            var colon = this.scriptSpec.indexOf(":");
            var comma = this.scriptSpec.indexOf(",");
            if(comma){
              // We have a column spec
              var columnbit = trimString(this.scriptSpec.substring(comma+1));
              this.script = trimString(this.scriptSpec.substring(colon+1, comma));
              if(columnbit.length){
                this.columns = Number(columnbit.split(/\s+/)[0]);
              }
            } else {
              this.script = trimString(this.scriptSpec.substring(colon+1));
            }
            break;
          case "Running heads:":
            this.running = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            if(this.running == "[none]"){
              this.running = false;
            }
            break;
          case "Date established:":
            this.established = trimString(consumeIf(/[^\r\n]*[\r\n]*/));
            break;
          case "Sources:":
            consumeSpace();
            var id, details;
            while(string.substring(0,10)!="&lt;treatise>" &amp;&amp; string.length
                                  &amp;&amp; !/^\n\n/.exec(string) &amp;&amp; string.substring(0, 6)!="&lt;piece"){
              id = consumeIf(/\S*/);
              consumeSpace();
              details = trimString(consumeIf(/[^\n\r]*/));
              this.sources.push(new Source(id, details));
              if(!/^\n\n/.exec(string)) consumeSpace();
            }
            break;
          default:
            // We've over-reached
            unRead(nextfield);
            return;
        }
        nextfield = consumeIf(/[^:\r\n]*:/);
      }
    };
    /** parse from codediv */
      this.parse = function(){
          // FIXME: Check what these do:
          resetAnnotations();
      resetDebugger();
          string = text;
          this.parseHeaders();
          // This is basically just a holder for a single piece, so let's find it
          var start = string.indexOf("&lt;piece")+7;
          var end = string.indexOf("&lt;/piece>");
          if(end&lt;-1) end = this.text.length;
          string = string.substring(start, end);
          try{
              this.example = new MusicExample();
          } catch(x){
              console.log(x.stack);
              console.log("error parsing example", currentExample);
              this.example = currentExample
              return false;
          }
          this.contents = [this.example];
    };
    /** Gets converted MEI and provides MEI links */
      this.toMEI = function(){
          var docObj = this.example.toMEI();
          var old = document.getElementById('MEILink');
          if(old) old.parentNode.removeChild(old);
          this.UUIDs = {};
          var MEIcoded = btoa(docObj.serialize());
          this.example.MEIcoded = MEIcoded;
          var anchor = DOMAnchor('MEI', 'MEILink', 'MEI', "data:application/xml;base64,"+MEIcoded);
          var anchor2 = DOMAnchor('MEI2', 'MEILink', 'verovio', 'viewer.html?mei='+encodeURI(MEIcoded));
          this.example.MEILink = anchor;
          this.example.VerovioLink = anchor2;
          anchor.setAttribute('download', 'editor.mei');
          anchor2.setAttribute('target', 'viewer');
          //document.body.appendChild(anchor);
          this.drawTo.appendChild(anchor);
          //document.body.appendChild(anchor2); ...this doesn't work anyway right now
          return docObj.serialize();
    };
    /** appendStaffDefs */
      this.appendStaffDefs = function(doc, el){
      var group = doc.createElementNS("http://www.music-encoding.org/ns/mei", "staffGrp");
      el.appendChild(group);
      if(this.example.parts &amp;&amp; this.example.parts.length){
        for(var i=0; i&lt;this.example.parts.length; i++){
                  if(!this.example.parts[i].closes &amp;&amp; this.example.parts[i].type==="part") {
                      group.appendChild(this.staffDefForPart(this.example.parts[i], i+1, doc));
                  }
        }
      } else {
              sd = doc.createElementNS("http://www.music-encoding.org/ns/mei", "staffDef");
              var p = this.example.parameters;
              var c = p.getClef();
              sd.setAttributeNS(null, "n", 1);
              sd.setAttributeNS(null, "lines", (p.staff.lines || 15));
              if(c){
                  sd.setAttributeNS(null, "clef.line", (c.staffPos/2) - 1);
                  sd.setAttributeNS(null, "clef.shape", (c.type || "C"));
              }
              group.appendChild(sd);
          }
    };
    /** staffDeff for Parts */
    this.staffDefForPart = function(part, n, doc){
      var sd = doc.createElementNS("http://www.music-encoding.org/ns/mei", "staffDef");
      var relevantStaff = part.applicableStaff();
      sd.setAttributeNS(null, "n", n);
      sd.setAttributeNS(null, "lines", relevantStaff.trueLines());
      return sd;
    };
    /** draw */
      this.draw = function(){
          state = "Starting to draw";
          curDoc = this;
          //editable=true;
          this.footnotes = [];
          if(!this.forceredraw &amp;&amp; this.out.childNodes.length){
              return;
          }
          state = "emptying drawTo (.draw())";
          $(this.drawTo).empty();
          // width of content div depends on editor or viewer
          if(standaloneEditor)
          {
            this.drawTo.style.width = (wrapWidth+20)+"px";
          }
          else
          {
            this.drawTo.style.width = wrapWidth+"px";
          }
          this.writeHeaders();
          state = "creating new svg – requires width and height";
          var newSVG = svg(this.example.width(), this.example.height());
          state = "adding SVG to drawTo";
          $(this.drawTo).removeClass("nowrap");
          this.drawTo.appendChild(newSVG);
      newSVG.className += " musicexample dc1";
          this.example.SVG = newSVG;
          state = "drawing";
          this.example.draw(newSVG, true);
          console.log(this.toMEI());
    };
    /** header text */
    this.headerText = function(){
      var text = (this.title ? this.title : "")+"\n";
      if(this.shortTitle) text += "Short-title: "+this.shortTitle+"\n";
      if(this.editor) text += "Editor: "+this.editor+"\n";
      if(this.translator) text += "Translator: "+this.translator+"\n";
      if(this.entered) text += "Data entry: "+this.entered+"\n";
      if(this.checked) text += "Checked by: "+this.checked+"\n";
      if(this.established) text += "Date established: "+this.established+"\n";
      if(this.approved) text += "Approved by: "+this.approved+"\n";
      if(this.copy) text += "Copy-text: "+this.copy+"\n";
      if(this.source) text += "Source: "+this.source+"\n";
      if(this.script || this.columns){
        text += "Script: ";
        if(this.script) text += this.script;
        if(this.columns) text += ", "+this.columns+" column"+(this.columns>1 ? "s" : "") + " per page";
        text += "\n";
      }
      if(this.running) {
        text += "Running heads: "+this.running+"\n";
      } else if(this.source){
        // this isn't a multiple-source edition
        text += "Running heads: [none]\n";
      }
      if(this.sources.length) {
        text += "Sources:\n";
        for(var i=0; i&lt;this.sources.length; i++){
          text += this.sources[i].toText();
        }
      }
      return text;
    };
      this.toText = function(){
          var text = "";
          text += this.headerText();
          return text + this.example.toText();
      };
      this.parse();
  }
// end of MusicHolder
//-------------------------------------------------------------------------------//  

 /**
  * @class
  * @classdesc Create Music example object.
  * @memberof music-container
  */
function MusicExample(){
    /** @property {string} objType
     * @summary string with object type
     */
    this.objType = "MusicExample";
    /** @property {string} code
     * @summary String with code in JT text format
     */
    this.code = string;
    /** @property {DOMElement} SVG
     * @summary rendered SVG
     */
    this.SVG = false;
    /** @property counter */
    this.counter = false;
    /** @property context */
    this.context = false;
    /** @property {Array} events
     * @summary Contains all the musical events
     */
    this.events = [];
    /** @property {Array} comments
     * @summary Array with all comments
     */
    this.comments = [];
    /** @property {Array} textObjects */
    this.textObjects = [];
    /** @property {number} drawCount */
    this.drawCount = 0;
    /** @property starts */
    this.starts = pointer;
    /** @property swidth */
    this.swidth = false;
    /** @property classes */
    this.classes = false;
    /** @property marginSpace */
    this.marginSpace = false;
    /** @property {Array}  marginalia*/
    this.marginalia = [];
    /** @property {Array} catchwords */
    this.catchwords = [];
    /** @property curCatchword */
    this.curCatchword = curCatchword;
    /** @property {Parameters} parameters */
    this.parameters = false;
    /** @property bbox */
    this.bbox = false;
    /** @property {Array} colbreaks */
    this.colbreaks = [];
    /** @property book */
    this.book = book;
    /** @property chapter */
    this.chapter = chapter;
    /** @property section */
    this.section = section;
    /** @property exampleno */
    this.exampleno = exampleno;
    /** @property {Array} exampleBreaks */
    this.exampleBreaks = [];
    /** @property {Array} staves */
    this.staves = [];
    /** @property {Array} parts */
    this.parts = [];
    /** @property {Array} done */
    this.done = [];
    /** @property {Object} UUIDs */
    this.UUIDs = {};
    /** @property MEI */
    this.MEI = false;
    /** @property {DOMElement} MEILink
     * @summary Link element to MEI doc
     */
    this.MEILink = false;
    /** @property MEIcoded */
    this.MEIcoded = false;
    /** @property {DOMElement} VerovioLink
     * @summary Link element to Verovio
     */
    this.VerovioLink = false;
    exampleno++;
    /** @property atClass */
    this.atClass = "at-"+this.book+"-"+this.chapter+"-"+this.section+"-"+this.exampleno;
    /**
     * Parses a MusicExample from string on top level. 
     * Parsing of lower levels is done by nextMusic()
     * @see nextMusic
     */
    this.parse = function(){
      this.staves = [];
      this.parts = [];
      var augmented = false;
      this.classes = new Classes();
      string = this.code;
      // Hacky fix for the problem of double asterisks in **
      // annotations: \** is converted to (the hopefully meaningless)
      // @@@@, and then back later
      string = string.replace(/\\\*\*/g, "@@@@");
      currentExample = this;
      initialStaffStar = false;
      var next;
      var length, prev;
          var openParts =[];
      currentClef = false;
      currentSolm = false;
          currentProp = 1;
      consumeSpace();
      this.parameters = getParameters();
      currentInfo = this.parameters;
      this.w2 = [];
      consumeSpace();
      while(string.length >0)
      {
        length = string.length;
        next = nextEvent();
        if(next)
        {
          if(prev) 
          {
            prev.next = next;
            next.previous = prev;
          }
          if(next.objType==="Part") 
          {
                      currentProp = 1;
                      next.wordNo = this.events.length;
            if(next.closes)
            {
                          let lastEl = openParts.pop();
                          if(next.type=="part")
                          {
                            currentClef = false;
                            currentSolm = false;
                          }
              if(lastEl)
              {
                              next.startEl = lastEl;
                              next.startEl.endEl = next;
              } 
              else 
              {
                              console.log("missed", this.events.slice(this.events.length -10));
                          }
            } 
            else 
            {
              if(openParts.length)
              {
                              let lowestOpen = openParts[openParts.length-1];
                              lowestOpen.contains.push(next);
                              next.parent = lowestOpen;
              } 
              else 
              {
                              console.log(next.type);
                          }
                          openParts.push(next);
                      }
                  }
                  if(next.changesProportion &amp;&amp; next.changesProportion()) currentProp = next.proportionChangesTo;
                  if(next.objType==="Part" &amp;&amp; next.type==="part") this.parts.push(next);
                  if(next.objType==="MusicalChoice" &amp;&amp; next.hasPart()) this.parts.push(next.hasPart());
          if(currentInfo)
          {
            if(infop(next))
            {
              currentInfo.extras.push(next);
              next.params = currentInfo;
              if(next.objType=="MusicalChoice") next.addParams(currentInfo);
            } 
            else if(!ignorable(next))
            {
              currentInfo = false;
            }
          } 
          else if(next.objType==="Staff")
          {
            if(prev.objType="Part" || prev.subType=="part")
            {
                          prev.staff = next;
                          next.part = prev;
                      }
            currentInfo = next;
            for (var i=this.events.length-1; i>0; i--)
            {
              if(this.events[i].objType==="TextUnderlay")
              {
                this.events[i].marginal="r";
                break;
              } 
              else if(this.events[i].objType!="NegativeSpace")
              {
                break;
              }
            }
          }
          if(next.objType==="SolmizationSignature" 
             &amp;&amp; this.events.length &amp;&amp; this.events[this.events.length-1].objType==="Clef")
              {
                this.events[this.events.length-1].solm = next;
              }
          if(next.objType=="Dot")
          {
            next.augments = augmented;
          } 
          else if(next.objType=="Fermata")
          {
            next.lengthens = augmented;
          } 
          else if(next.objType==="SignumCongruentiae")
          {
            // console.log(currentChoice, this.events[this.events.length-1]);
            if(currentChoice)
            {
              console.log("it happened");
              next.effects = currentChoice;
            } 
            else 
            {
              next.effects = this.events[this.events.length-1];
            }
          } 
          else if (next.objType==="Comment" &amp;&amp; this.events.length &amp;&amp; 
                     this.events[this.events.length-1].objType==="Ligature")
            {
              var c = new LigatureComment(next);
              currentExample.comments.push(c);
              this.events[this.events.length-1].members.push(c);
              // I think this is necessary because otherwise we get two
              // comments -- a ligature comment and a normal comment
              next = c;
              prev = next;
              continue;
            } 
          else if(next.objType=="MusicalChoice" &amp;&amp; augmented 
                    &amp;&amp; next.content.length //&amp;&amp; !next.content[0].nonDefault()
                    &amp;&amp; next.content[0].content.length &amp;&amp; next.content[0].content[0].objType==="Fermata")
            {
              next.content[0].content[0].lengthens = augmented;
            }
          if(next.objType==="TextUnderlay" &amp;&amp; this.events.length
             &amp;&amp; typeof(this.events[this.events.length-1].text) !=="undefined"
             &amp;&amp; !this.events[this.events.length-1].text) 
            {
              if(this.events[this.events.length-1].objType !== "SignumCongruentiae")
              {
                // FIXME: This is a painful hack. sig cong is treated by
                // the system as an event in its own right, that happens
                // to take its position from the note before. That would
                // be fine, even if we add text, but not if the text
                // should alter the position of the note that the sig cong
                // attaches to. In that case, we'd draw it before adjusting the position.
                if(last(this.events).objType==="Dot" &amp;&amp; last(this.events).augments)
                  {
                                  // If a dot follows a note, put the text under the note
                                  last(this.events).augments.text=next;
                  }
                else if (last(this.events).objType==="Fermata" &amp;&amp; last(this.events).lengthens)
                {
                                // If a fermata follows a note, put the text under the note
                  last(this.events).lengthens.text=next;
                } 
              else 
              {
                              this.events[this.events.length-1].text=next;
                          }
            } 
            else if (this.events.length>1)
            {
              this.events[this.events.length-2].text=next;
            }
          } 
          else 
          {
            this.events.push(next);
          }
          prev = next;
        } 
        else if(length == string.length)
        {
          // We're stuck in a loop. Try to escape
          string = string.substring(1);
        }
        // if there's no whitespace, following dot is of augmentation
        augmented= consumeSpace() ? false : next;
      }
      correctNexts(this.events);
    };
    /** Reset MusicExample
     */
    this.reset = function(){
      this.swidth = false;
      this.drawCount = 0;
      this.w2 = [];
      this.events = [];
      this.comments = [];
      curCatchword = this.curCatchword;
      this.parse();
    };
    /** width 
     * @returns {number} width */
    this.width = function(){
          state = "finding width";
      if(this.swidth) {
        return this.swidth;
      } else {
        this.setSysWidths();
        return this.swidth;
        var w = 0;
        for(var e=0;e&lt;this.events.length; e++){
          var w2 = this.events[e].startX ? this.events[e].startX : 0;
          w2 += typeof(this.events[e].width) != "undefined" ? this.events[e].width() : 0;
          w = Math.max(w, w2);
        }
        this.swidth = w;
        return w;
      }
    };
    /** commentsDiv 
     * @returns {ExampleComments} new Comment to the current example or false */
    this.commentsDiv = function(){
      return new ExampleComments(this.comments);
    };
    /** commentsTip provides comments tip 
     * @param x
     * @param y */
    this.commentsTip = function(x, y){
      for(var i=0; i&lt;this.comments.length; i++){
        if(x>=this.comments[i].startX &amp;&amp; x&lt;=this.comments[i].endX
           &amp;&amp; y>=this.comments[i].endY &amp;&amp; y&lt;=this.comments[i].startY){
          return Tooltip(this.comments[i].content);
        } 
      }
      removeTooltip();
      return false;
    };
    /** height
     * @returns height
     */
    this.height = function(){
      // FIXME: clearly stupid
          state = "finding height";
      var height = rastralSize * 
        (!this.parameters.staff || typeof(this.parameters.staff) == "undefined" ? 
         1 : (this.parameters.staff.trueLines() + 4));
      // for(var i=0; i&lt;this.events.length; i++){
      //   if(this.events[i].objType == "Staff"){
      //     height += rastralSize * 9 + 5;
      //   }
      //}
      this.setSysWidths();
      height = sysWidths.length * height + 15;
      return height;
    };
    /** targetWidth
     * @returns width of target
     */
    this.targetWidth = function(){
      return (wrapWidth 
              ? (wrapWidth - (rastralSize * 3) - (lmargin+10) - (this.marginSpace ? 100 : 0))
              : false);
    };
    /** sets system width */
    this.setSysWidths = function(){
      sysWidths = [rastralSize + this.parameters.width()];
      this.swidth = 0;
    //    var x = lmargin +rastralSize/2;
      for(eventi=0; eventi&lt;this.events.length; eventi++){
        if(this.events[eventi].objType == "Staff" 
  //         || (wrapWidth &amp;&amp; sysWidths[sysWidths.length-1] >= this.targetWidth())){
           || (wrapWidth &amp;&amp; sysWidths[sysWidths.length-1] >= this.targetWidth())){
  //             (wrapWidth - rastralSize*3 - lmargin-10)){
          sysWidths[sysWidths.length-1] += rastralSize * 2;
          if(sysWidths[sysWidths.length-1]+lmargin>SVG.width){
            sysWidths[sysWidths.length-1] = SVG.width - lmargin;
          }
          this.swidth = Math.max(this.swidth, sysWidths[sysWidths.length-1]);
          sysWidths.push(rastralSize);
        } else {
          if(isNaN(this.events[eventi].width())){
            alert("Width estimation failed: "+ this.events[eventi].objType
                 + " gives: " + this.events[eventi].width());
          }
          // x+=this.events[eventi].width();
          // drawVerticalLine(x+0.5, 0, 250, 2, "#1F6");
          sysWidths[sysWidths.length -1] +=this.events[eventi].width();
        }
      }
      this.swidth = Math.max(this.swidth, sysWidths[sysWidths.length-1]);
    };
    /** Saves the MusicExample back to its text form
     * @returns text
     */
    this.toText = function(){
      var text = this.parameters.toText();
      for(var i=0; i&lt;this.events.length; i++){
        if(i>0) text += " ";
        if(typeof(this.events[i].toText) == "undefined") 
          alert("error - "+JSON.stringify(this.events[i]));
        text += this.events[i].toText();
      }
          if(standaloneEditor){
              text += "&lt;/piece>";
          } else {
              text += "&lt;/example>";
          }
      return text;
    };
    /** Writes MusicExample to MEI
     * @returns {MEIDoc} MEI document object
     */
      this.toMEI = function(){
          this.UUIDs = {};
          var docObj = new MEIDoc();
          var doc = docObj.doc;
          var music = doc.createElementNS("http://www.music-encoding.org/ns/mei", "music");
          var body =  doc.createElementNS("http://www.music-encoding.org/ns/mei", "body");
          var mdiv = doc.createElementNS("http://www.music-encoding.org/ns/mei", "mdiv");
      var mscore = doc.createElementNS("http://www.music-encoding.org/ns/mei", "score");
      var msection = doc.createElementNS("http://www.music-encoding.org/ns/mei", "section");
          var mscoredef = doc.createElementNS("http://www.music-encoding.org/ns/mei", "scoreDef");
          var staffn = 1;
          this.done = [];
          docObj.tree.appendChild(music);
          music.appendChild(body);
          body.appendChild(mdiv);
      mdiv.appendChild(mscore);
          mscore.appendChild(mscoredef);
          var msectionIsNew = true;
  //		mscore.appendChild(msection);
  //		msection.appendChild(mstaff);
  //		mstaff.appendChild(mlayer);
      currentExample = this;
      if(this.parameters &amp;&amp; this.parameters.toMEI) {this.parameters.toMEI(doc, msection);}
      this.appendStaffDefs(doc, mscoredef);
          var started = false;
          var extras = [];
          var inExtra = false;
          console.log("making MEI");
          var currentPartes = [];
          var currentParsi = 0;
          var parti=0;
          var sic = false;
          var n=0;
          var mstaff = false;
          // I don't know why this isn't happening later, but adding this unbreaks things [DL 05/20]
          var mlayer = doc.createElementNS("http://www.music-encoding.org/ns/mei", "layer");
      // more
          for(var i=0; i&lt;this.events.length; i++){
              var prevLength = currentPartes.length;
              if(this.events[i].objType==="Part"
                   &amp;&amp; this.events[i].type==="part"
                   &amp;&amp; !this.events[i].closes){
                  parti++;
                  n = Object.keys(this.voiceParts).indexOf(this.events[i].defaultName())+1;
                  currentParsi=0;
                  mstaff = doc.createElementNS("http://www.music-encoding.org/ns/mei", "staff");
                  mlayer = doc.createElementNS("http://www.music-encoding.org/ns/mei", "layer");
                  mstaff.setAttribute('n', n > -1 ? n : parti);
                  mstaff.appendChild(mlayer);
                  if(this.events[i].id){
                      mstaff.setAttribute('label', this.events[i].id);
                  }
              } // else if (this.events[i].objType==="Part"
              // 					 &amp;&amp; this.events[i].type==="pars"
              // 					 &amp;&amp; !this.events[i].closes
              // 					 &amp;&amp; this.events[i].id==="sic") {
              // 	var extraStaff = doc.createElementNS("http://www.music-encoding.org/ns/mei", "staff");
              // 	mlayer = doc.createElementNS("http://www.music-encoding.org/ns/mei", "layer");
              // 	extraStaff.setAttributeNS(null, 'n', parti);
              // 	extraStaff.setAttributeNS(null, 'extra', 'true');
              // 	extraStaff.appendChild(mlayer);
              // 	extras.push([extraStaff, currentPartes.length]);
              // 	inExtra = true;
              // } 
              else if (this.events[i].objType==="Part"
                                   &amp;&amp; this.events[i].type==="pars"
                                   &amp;&amp; !this.events[i].closes) {
                  // These partes are presented in sequence within a voice
                  sic = this.events[i].id==="sic" ? true : false;
                  if(parti===1) {
                      var msubsection = doc.createElementNS("http://www.music-encoding.org/ns/mei", "section");
                      currentPartes.push(msubsection);
                  } else {
                      msubsection = currentPartes[currentParsi];
                      if(!sic) currentParsi++;
                  }
                  mstaff = doc.createElementNS("http://www.music-encoding.org/ns/mei", "staff");
                  mlayer = doc.createElementNS("http://www.music-encoding.org/ns/mei", "layer");
                  mstaff.setAttribute('n', sic ? parti+10 : (n>-1 ? n : parti));
                  mstaff.appendChild(mlayer);
                  if(this.events[i].id){
                      mstaff.setAttribute('label', this.events[i].id);
                  }
                  inExtra = false;
              } else if (this.events[i].objType==="Part"
                                   &amp;&amp; this.events[i].type==="section"
                                   &amp;&amp; !this.events[i].closes) {
                  currentParsi=0;
                  staffn = 0;
                  parti = 0;
                  msection = doc.createElementNS("http://www.music-encoding.org/ns/mei", "section");
                  msectionIsNew = true;
                  currentPartes = [];
                  if(this.events[i].id) msection.setAttribute('label', this.events[i].id);
                  inExtra = false;
              } else if(this.events[i].toMEI &amp;&amp; this.done.indexOf(this.events[i])===-1){
                  if(msection &amp;&amp; msectionIsNew) mscore.appendChild(msection);
                  if(msubsection) {
                      msection.appendChild(msubsection);
                      if(mstaff) msubsection.appendChild(mstaff);
                  } else if(!inExtra){
                      if(mstaff) msection.appendChild(mstaff);
                  }
                  msectionIsNew = false;
                  mstaff = false;
                  msubsection = false;
                  if(!mlayer) console.log(this.events[i]);
                  this.events[i].toMEI(doc, mlayer);
                  started = true;
              }
          }
          return docObj;
    };
    /** @summary easyRhythms starts trivial beat analysis 
     * @see getAtomicSections
     * @see getEventsByMensurationForSection
     * @see beatIndependentDurations
     * @see addAllStartTimes
     * @returns {MEIDoc} MEI document with resolved rhythm */
      this.easyRhythms = function(){
          var MEIDoc = this.toMEI();
          var layerMens = [];
          this.MEI = MEIDoc;
          var sections = getAtomicSections(MEIDoc);
          for(var i=0; i&lt;sections.length; i++){
              var layers = getLayers(sections[i]);
              for(var layi=0; layi&lt;layers.length; layi++){
                var sectionBlocks = getEventsByMensurationForSection(layers[layi], MEIDoc.doc,
                                                                                                                           layerMens.length>layi ? layerMens[layi] : false);
                  layerMens[layi] = sectionBlocks[sectionBlocks.length-1].mens;
                  beatIndependentDurations(sectionBlocks);
                  //	 			labelEasyDurationsAndStartTimes(sectionBlocks);
                  addAllStartTimes(sectionBlocks);
                  //var remaining = resolveForKnownStartingPoints(sectionBlocks);
                  //addAllStartTimes(sectionBlocks);
                  //simplestAlterations(sectionBlocks);
                  //addAllStartTimes(sectionBlocks);
                  var remaining = 1000000000;
                  var nextRemaining = afterTheEasyBits(sectionBlocks);
                  while(nextRemaining != 0 &amp;&amp; remaining!=nextRemaining){
                      // Rerun this for as long as it makes a difference
                      // (i.e. resolves unsolved durations/start times)
                      console.log("unresolved count", remaining, nextRemaining);
                      remaining=nextRemaining;
                      nextRemaining = afterTheEasyBits(sectionBlocks);
                  }
                  console.log(remaining);
                  this.stupidVerovioStretch();
                  this.mensurStrich();
                  this.markResolved();
                  this.regenerateMEILinks();
              }
          }
          return MEIDoc;
    };
    /** regenerateMEILinks
      */
      this.regenerateMEILinks = function(){
          this.MEIcoded = btoa(this.MEI.serialize());
          this.MEILink.setAttributeNS(null, 'href', "data:application/xml;base64,"
                                                                                  +this.MEIcoded);
          this.VerovioLink.setAttributeNS(null, 'href', 'viewer.html?mei='+encodeURI(this.MEIcoded));
    };
    /** Deals with the unability of Verovio to do proportions
     */
      this.stupidVerovioStretch = function(){
          // Verovio can't do proportions
          for(var e=0; e&lt; this.events.length; e++){
              if(this.events[e].objType==="Note" || this.events[e].objType==="Rest"){
                  var object = this.events[e].MEIObj;
                  if(object.getAttributeNS(null, 'dur.intermediate')
                       &amp;&amp; object.getAttributeNS(null, 'dur.intermediate')
                       != object.getAttributeNS(null, 'dur.ges')
                       &amp;&amp; !object.getAttributeNS(null, 'stretched')){
                      // A proportion has been applied
                      var realised = object.getAttributeNS(null, 'dur.ges');
                      var implied = object.getAttributeNS(null, 'dur.intermediate');
                      var realno = Number(realised.substring(0, realised.length-1));
                      var implno = readDur(object);
                      var proportion = realno / implno;
                      var numb = Number(object.getAttributeNS(null, 'numbase'));
                      if(numb){
                          object.setAttributeNS(null, 'numbase', numb*proportion );
                          object.setAttributeNS(null, 'stretched', 'true');
                      } else {
                          object.setAttributeNS(null, 'numbase', proportion );
                          object.setAttributeNS(null, 'num', '1' );
                          object.setAttributeNS(null, 'stretched', 'true');						
                      }
                  }
              }
                       
          }
    };
    /** Removes old mensurStrich elements and draws barLines
     */
      this.mensurStrich = function(){
          var old = Array.from(document.getElementsByClassName('mensurStrich'));
          if(old) old.forEach(x => x.remove());
          for(var e=0; e&lt;this.events.length; e++){
              if(this.events[e].objType==="Note" || this.events[e].objType==="Rest"){
                  var object = this.events[e].MEIObj;
                  if(object.getAttributeNS(null, 'onTheBreveBeat')
                       || object.getAttributeNS(null, 'crossedABreveBeat')
                       || parseInt(object.getAttributeNS(null, 'onTheBreveBeat'), 10)===0){
                      // We've crossed a breve beat
                      drawMensurStrich(this.events[e]);
                      if(object.getAttributeNS(null, 'onTheBreveBeat')
                           &amp;&amp; object.previousSibling &amp;&amp; object.previousSibling.tagName!="barLine"){
                          let line = object.ownerDocument.createElementNS("http://www.music-encoding.org/ns/mei", "barLine");
                          line.setAttributeNS(null, "visible", "false");
                        object.parentNode.insertBefore(line, object);
                      }
                  }
              }
          }
    };
    /** markedResolved */
      this.markResolved = function(){
          for(var e=0; e&lt;this.events.length; e++){
              if(this.events[e].objType==="Note" || this.events[e].objType==="Rest"
                   || this.events[e].objType==="MaxRest"  || this.events[e].objType==="LongRest"){
                  var MEIObj = this.events[e].MEIObj;
                  if(MEIObj.getAttributeNS(null, 'dur.ges')){
                      var DOMObj = this.events[e].domObj;
                      if(!DOMObj){
                          console.log("problem with", e, this.events[e]);
                          continue;
                      }
                      DOMObj.classList.add('resolved');
                      if(MEIObj.getAttributeNS(null, 'quality')){
                          DOMObj.classList.add(MEIObj.getAttributeNS(null, 'quality'));
                      }
                      if(MEIObj.getAttributeNS(null, 'rule')){
                          DOMObj.classList.add(MEIObj.getAttributeNS(null, 'rule'));
                      }
                  }
              } else if(this.events[e].objType==="Ligature"){
                  if(this.events[e].members.every(isResolved)){
                      this.events[e].domObj.classList.add('resolved');
                  }
              }
          }
    };
    /**
     * exports MusicExample to TEI
     * @todo Old code, propably not valid MEI or TEI
     * @param doc
     * @param parent
     */
    this.toTEI = function(doc, parent){
          // FIXME: Old code, probably not valid MEI or TEI
      if(!parent) parent=(doc.currentParent || doc.body);
      var musicel = doc.element("notatedMusic");
      var mdiv = doc.element("mei:mdiv");
      var mscore = doc.element("mei:score");
      var msection = doc.element("mei:section");
      currentExample = this;
      parent.appendChild(musicel);
      musicel.appendChild(mdiv);
      mdiv.appendChild(mscore);
  //    mscore.appendChild(msection);
      if(this.parameters &amp;&amp; this.parameters.toMEI) this.parameters.toMEI(doc, msection);
      // more
      //this.appendStaffDefs(doc, mscore);
    };
    /** gatherStaffs
     * @param parts
     * @returns {Object} voices
     */
      this.gatherStaffs = function(parts){
          var voices = {};
          var voiceParts = this.parts.filter(x=>x.type=="part"&amp;&amp;!x.startEl);
          for(var i=0; i&lt;voiceParts.length; i++){
              let name = voiceParts[i].defaultName();
              if(voices[name]){
                  voices[name].push(voiceParts[i]);
              } else {
                  voices[name] = [voiceParts[i]];
              }
          }
          return voices;
    };
    /** appendStaffDefs
     * @param doc
     * @param el Element
     */
    this.appendStaffDefs = function(doc, el){
      var group = doc.createElementNS("http://www.music-encoding.org/ns/mei", "staffGrp");
          var counter = 1;
          this.voiceParts = this.gatherStaffs(this.parts);
          var voiceTypes = Object.keys(this.voiceParts);
          var  sd;
      el.appendChild(group);
          if(voiceTypes.length){
              for(var i=0; i&lt;voiceTypes.length; i++){
                  group.appendChild(this.staffDefForPart(this.voiceParts[voiceTypes[i]][0], i+1, doc));
              }
          } else if(this.parts &amp;&amp; this.parts.length){
        for(var i=0; i&lt;this.parts.length; i++){
                  if(!this.parts[i].closes &amp;&amp; this.parts[i].type==="part") {
                      group.appendChild(this.staffDefForPart(this.parts[i], counter++, doc));
                  }
        }
      } else {
              sd = doc.createElementNS("http://www.music-encoding.org/ns/mei", "staffDef");
              var p = this.parameters;
              var c = p.getClef();
              sd.setAttributeNS(null, "n", 1);
              console.log(p);
              sd.setAttributeNS(null, "lines", (p.staff.trueLines() || 15));
              if(c){
                  if(c.objType==="MusicalChoice"){
                      if(!c.nonDefault()){
                          this.done.push(c);
                          var clefs = c.content[0].content.filter(e => e.objType==='Clef');
                          if(clefs.length){
                              c = clefs[0]
                              sd.setAttributeNS(null, "clef.line", (c.staffPos/2) - 1);
                              sd.setAttributeNS(null, "clef.shape", (c.type || "C"));
                          }
                      }
                  } else {
                      sd.setAttributeNS(null, "clef.line", (c.staffPos/2) - 1);
                      sd.setAttributeNS(null, "clef.shape", (c.type || "C"));
                  }
              }
              group.appendChild(sd);
          }
    };
    /** staffDefForPart
     * @param part
     * @param n
     * @param doc
     * @returns {Element} MEI staff def
     */
    this.staffDefForPart = function(part, n, doc){
      var sd = doc.createElementNS("http://www.music-encoding.org/ns/mei", "staffDef");
      var relevantStaff = part.applicableStaff();
      sd.setAttributeNS(null, "n", n);
      sd.setAttributeNS(null, "lines", relevantStaff.trueLines());
          if(part.id) {
              sd.setAttributeNS(null, "label", part.defaultName());
          }
      return sd;
    };
    /** startingStaffForPart
     * @todo not implemented!
     * @param part
     * @param pos
     */
    this.startingStaffForPart = function(part, pos){
      
    };
    this.currentSolm = function(variant){
      // We're not really keeping track of staves properly for cases
      // where line breaks are automatic (because automatic system
      // breaks came later). This method looks back to find an
      // applicable solmisation signature. N.B. variant allows other
      // uses to be made of this, but would normally just be false.
      for(var j=eventi-1; j>=0; j--){
        if(this.events[j].objType==="SolmizationSignature" 
           &amp;&amp; (!this.events[j].appliesTo
               || (variant &amp;&amp; this.events[j].appliesTo.indexOf(variant)>-1))){
          // Easy – this is a normal signature and applies here
          return this.events[j];
        } else if(this.events[j].objType==="MusicalChoice" &amp;&amp; !this.events[j].nonDefault()){
          // Complicated – applicable signatures might be buried (probably not, though)
          for(var k=this.events[j].content[0].content.length-1; k>=0; k--){
            var obj = this.events[j].content[0].content[k];
            if(obj.objType==="SolmizationSignature"){
  //            &amp;&amp; (!obj.appliesTo
  //                || (variant || obj.appliesTo.indexOf(variant)>-1))){
              return obj;
            } else if(obj.objType==="MusicalChoice" &amp;&amp; !obj.nonDefault()){
              // Choice in a choice. If I defined this functionality
              // sensibly (recursively), I could handle any depth of
              // choices, but it's probably better to discourage using
              // that in practice, and only implementing it if
              // necessary. Plus, this patch is overdue...
              for(var l=obj.content[0].content.length-1; l>=0; l--){
                if(obj.content[0].content[l].objType==="SolmizationSignature"){
  //                 &amp;&amp; (!obj.content[0].content[l].appliesTo
  //                    || (variant &amp;&amp; obj.content[0].content[l].appliesTo.indexOf(variant)>-1))){
                  return obj.content[0].content[l];
                }
              }
            }
          }
        }
      }
      console.log("missed");
      return false;
    };
    this.draw = function(exampleSVG, force){
  //    if(exampleSVG != this.SVG) alert("ok");
      // FIXME: 14/10/12 If this shows no alerts, remove this and all
      // svg passing
      // if(this.drawCount>1 &amp;&amp; !force){
      //   alert("oh really?");
      //   return;
      // }
      // 22/01/12 This showed up for redrawing punctuation. FIXME: find
      // out what's happening
      underlays = [];
      this.drawCount++;
  //    this.catchwords = [];
      currentClef = false;
      currentSolm = false;
          leaveSpace = false;
      currentExample = this;
      var st = this.parameters.staff;
      currentLinecount = st ? st.trueLines() : 1;
      currentStaffColour = st ? st.trueColour() : "black";
      curx = lmargin;
      cury = topMargin;
      lowPoint = cury+(rastralSize*2);
      currentType = this.parameters.notation;
      currentSubType = this.parameters.notationSubtype;
      currentRedline = false;
      SVG = this.SVG;//exampleSVG;
      // this.SVG = SVG; // ??
      clearSVG(SVG);
      svgCSS(SVG, cssPath("jt-editor-v.css"));
  //    svgCSS(SVG, cssPath("print.css"));
      this.w2 = [];
      currentSystems = [];
      var fontstring = Math.round(3 * rastralSize * prop) +"pt ArsNovaVoidRegular";
      context.font = fontstring;
  //    this.setSysWidths();
      localWidth = exWidth;
      sysNo = 1;
      curx += rastralSize / 2;
      var mw = curx;
      var texted = false;
      var maxx = false;
      var remain = this.events.length;    
      var nextBreak = this.indexOfStaffBreak();
          var preRot;
      currentSystems.push(svgGroup(SVG, "Stafflines", false));
      this.parameters.draw();
      var broken=false;
      // some helpers for better system breaks
      var sysbreakWidth = this.targetWidth()-(3*rastralSize);
      var remainingEvents = this.events;
      for(eventi = 0; eventi&lt;this.events.length; eventi++){
        if(!broken &amp;&amp; currentSolm &amp;&amp; currentSolm.members.length &amp;&amp; eventi>0) {
          broken=true;
        }
        // console.log(this.events[eventi], curx);
        remain--;
        if(eventi>nextBreak) nextBreak = this.indexOfStaffBreak(1+nextBreak);
        //reset currentClef and currentSolm at the end of a part (and ONLY A PART, NOT A PARS!!!!)
        if(this.events[eventi].objType==="Part" &amp;&amp; this.events[eventi].closes &amp;&amp; this.events[eventi].type=="part")
        {
          currentClef = false;
          currentSolm = false;
        }
        // determine automatic system breaks in case of wrapWidth... are we near the end of space?
        // Make sure to prevent a crash if nextBreak is false... (Why is this possible?!)
        if(wrapWidth &amp;&amp; 
          determineSysBreak(remainingEvents, sysbreakWidth, 
            (nextBreak!=false ? nextBreak - eventi: remain), remain))
        {
          // The custos has to know the next (=current) note, so rewind
          // the pointer, briefly
          eventi-=1;
          var custos = new Custos();
          custos.draw();
                  if(this.events[eventi].classList){
                      // ledger lines
                      for(var l=0; l&lt;this.events[eventi].classList.length; l++){
                          if(this.events[eventi].classList[l].objType==="LedgerLineChange"){
                              this.events[eventi].classList[l].coordinates.push(curx);
                          }
                      }
                  }
          eventi+=1;
          sysBreak2();
          sysBreak(false, leaveSpace);
          // draw Clef &amp; Solm only if the next object is no clef
          if(this.events[eventi+1] &amp;&amp; this.events[eventi+1].objType!=="Clef")
          {
            if(currentClef) currentClef.draw();
            //console.log(currentClef.appliesTo);
            var realSolm = this.currentSolm(false);
            if(realSolm) realSolm.draw();
          }
          
          this.SVG.height.baseVal.value = this.SVG.height.baseVal.value 
            + (rastralSize*5)+5+(currentLinecount*rastralSize);
        }
        if(this.events[eventi].objType &amp;&amp; (!this.events[eventi].params || this.events[eventi].objType==="Staff")) {
          try {
            if(currentRedline &amp;&amp; removeRedlineBefore(this.events[eventi].classList)) currentRedline = false;
            if(this.events[eventi].objType==="Part" &amp;&amp; this.events[eventi].staff) {
                //console.log("Part will be displayed on new system");
              } 
            else if (this.events[eventi].objType==="UpsideDownOpen"){
                preRot = SVG;
                SVG = svgGroup(preRot, 'flippin', false);
              } 
            else if (this.events[eventi].objType==="UpsideDownClose"){
                var box = SVG.getBBox();
                var halfwayX = box.x + (box.width / 2);
                var halfwayY = cury - (3*rastralSize);
                SVG.setAttributeNS(null, "transform", "rotate(180, "+halfwayX+", "+halfwayY+")");
                SVG = preRot;
              } 
            else {
                this.events[eventi].draw();
              }
            // this.events[eventi].draw(curx, cury); // obsolete
          } catch (x) {
            console.log(x, this.events[eventi]);
          }
          if(this.events[eventi].objType == "TextUnderlay"
             || this.events[eventi].text){
            texted = true;
          }
        }
        mw = Math.max(curx, mw);
        remainingEvents = remainingEvents.slice(1);
      } // end of for loop
      if(this.classes.classes.length) drawClasses(this.classes.classes, false);
      sysBreak2(true);
      for(var w=0; w&lt;this.w2.length; w++){
        drawSystemLines(currentSystems[w], this.w2[w][2], this.w2[w][1], lmargin, 
          this.w2[w][0], this.w2[w][3]);
        maxx = Math.max(this.w2[w][0], maxx);
      }
      for(var coli=0; coli&lt;this.colbreaks.length; coli++){
        ColBreakWidth(this.colbreaks[coli], mw);
      }
      var box = this.SVG.getBoundingClientRect();
      if(!box.height) {
        //      alert("Rectangle error"+this.code);
        // FIXME: Certainly still causes brokenness
  //      this.SVG.height.baseVal.value = 64;
        var max= false, min=false, b;
        for(var n=0; n&lt;SVG.childNodes.length; n++){
          b=SVG.childNodes[n].getBoundingClientRect();
          if(b.top &amp;&amp; (!min || b.top&lt;min)) min = b.top;
          if(b.bottom &amp;&amp; (!max || b.bottom>max)) max = b.bottom;
        }
        this.SVG.height.baseVal.value = Math.max(64, max-min + (texted ? 30 : 0));
      } else {
          var bbox = this.SVG.getBBox();
          this.bbox = bbox;
          var top = bbox.y &lt; 0 ? bbox.y -1 : 0;
          var bottom = bbox.y+bbox.height+1;
          var height = bottom - top;
          if(top) {
            var nudge = rastralSize*-2.55;
            if($(this.SVG.parentNode).hasClass("inline")) {
              // this.SVG.parentNode.style.marginTop = "-35px";
              this.SVG.parentNode.style.marginTop = (-2*rastralSize)+"px";
              if(this.w2[0][2]===3){
                nudge -= rastralSize/2;
                // nudge -= rastralSize;
              }
            }
            if(safari) this.w2[0][2]===3 ? nudge+=2 : nudge+=4;
            this.SVG.parentNode.style.verticalAlign = nudge-top+"px";
          } 
          this.SVG.setAttribute('height', height);
          this.SVG.height.baseVal.value = height;
          this.SVG.style.height = height+"px";
          this.SVG.setAttribute('viewBox', bbox.x+" "+top+" "+bbox.width+" "+height);//bbox.height);
          this.SVG.width.baseVal.value = bbox.width+bbox.x;
        // } else {
        //   this.SVG.height.baseVal.value = Number(box.height); //+ (texted ? 35 : 5);
        // }
  //      this.SVG.height.baseVal.value = Number(SVG.getBoundingClientRect().height) + (texted ? 35 : 5);
  //      this.SVG.style.height = (Number(SVG.getBoundingClientRect().height) + (texted ? 35 : 5)+10)+"px";
      }
  //     if(!$.browser.webkit){
  // //      this.SVG.width.baseVal.value = maxx + (texted ? 25 : 5);
  //       this.SVG.width.baseVal.value = this.SVG.getBBox().
  //     }
      // this.SVG.parentNode.style.width = maxx+(texted ? 25 : 5)+8+"px";
      if(!inTip // &amp;&amp; !editorMode
        ){
        $(this.SVG).hover(function(e){displayStatusBarReference(this, e);});
      }
      currentExample = false;
      eventi = false;
    };
    this.indexOfStaffBreak = function(start){
      for(var si=0; si&lt;this.staves.length; si++){
        if((!start || this.staves[si][0]>=start) &amp;&amp; this.staves[si][1].objType==="Staff") {
          return this.staves[si][0];
        }
      }
      return false;
    };
    this.parse();
    currentExample = false;
  }
  // end of MusicExample
  
  /**
   * @memberof music-container
   * Checks if an automatic system break is necessary.
   * This is done in a separate function for better traceability.
   * @param {Array} remainingEvents 
   * @param {int} sysbreakWidth 
   * @param {int} toNextBreak 
   * @param {int} remain 
   * @returns {boolean} advise break
   */
  function determineSysBreak(remainingEvents, sysbreakWidth, toNextBreak, remain)
  {
    var breakSys = false;
    var currentEvent = remainingEvents[0];
    var curText = getDefaultText(currentEvent);
    var curWidth = curText ? curText.width() : currentEvent.width();

    // We need to check for things that should not be broken at!
    var dontBreak = needToPreventBreak(currentEvent);
    // Result is applied at the end, because it cancels the break

    // Advise an earlier break because of the following events:
    if (!dontBreak)
    {
      let fiveGram = remainingEvents.slice(0,5);
      let fiveGramWidth = getGroupWidth(fiveGram);
      // if the next 3 events won't fit, determine if an earlier break is desired
      if(curx + fiveGramWidth > sysbreakWidth)
      {
        breakSys = dontSplitGram(fiveGram);
      }
    }
    
    // Break if: (yep, the code is redundant, but it's easier to debug if cases are properly separated)
    // X + width of current event would reach beyond recommended system width
    if(curx + curWidth >= sysbreakWidth)
    {
      breakSys = true;
    }
    // no break seems to be necessary because of remaining space
    // check if we would like to break earlier because of future stuff
    else if(remain &lt; 5)
    {
      // break earlier near the end because the rest won't fit?
      let restWidth = getGroupWidth(remainingEvents);
      
      if(curx + restWidth > sysbreakWidth)
      {
        breakSys = true;
      }

    }
    else if(toNextBreak > 0 &amp;&amp; toNextBreak &lt; 8 &amp;&amp; toNextBreak != remain)
    {
      // we're near a break, check whether it's a default break
      // then check if we would like to break early
      let breakEvent = remainingEvents[toNextBreak];
      
      if(breakEvent.objType!=="MusicalChoice" || !breakEvent.nonDefault())
      {
        let toBreakWidth = getGroupWidth(remainingEvents.slice(0,toNextBreak+1));

        if(curx + toBreakWidth > sysbreakWidth)
        {
          breakSys = true;
        }
      }
    }

    // prevent a break
    if(dontBreak===true)
    {
      breakSys = false;
    }

    return breakSys;
  }

  /**
   * @memberof music-container
   * Determines the estimated width of a group of events
   * @param {Array} eventGroup Group of events
   * @returns {int} total width of group
   */
  function getGroupWidth(eventGroup)
  {
    var grpWidth = 0;
    for(let i = 0; i &lt; eventGroup.length; i++)
    {
      let thisItemWidth = eventGroup[i].text ?
        getDefaultText(eventGroup[i]).width() : eventGroup[i].width();
      grpWidth = grpWidth + thisItemWidth;
    }

    return grpWidth;
  }

  /**
   * @memberof music-container
   * Checks whether an event should not be put in a new system.
   * Usually, the object type contradicts a break.
   * @param {*} event 
   * @returns {boolean} Don't break!
   */
  function needToPreventBreak(event) 
  {
    var dontBreak = false;

    if(event)
    {
      switch(event.objType)
      {
        case "TextUnderlay":
        case "Part":
        case "Staff":
        case "Barline":
        case "Custos":
          dontBreak = true;
          break;
        case "MusicalChoice":
          //In case of a choice, look at first event in default Reading
          let defaultRdg = getDefaultReading(event);
          dontBreak = needToPreventBreak(Array.isArray(defaultRdg) ? defaultRdg[0] : defaultRdg);
          break;
        default:
          dontBreak = false;
          break;
      }
    }

    return dontBreak;
  }

  /**
   * @memberof music-container
   * Checks for following events that shouldn't be split and advises a split just before
   * @param {Array} nGram 
   * @returns {boolean} advise split now
   */
  function dontSplitGram(nGram)
  {
    var splitNow = false;

    /**
     * We have various reasons to split:
     * --- Because of first event (in case of choices, check only first item of default reading)
     * - First is a clef
     * - Don't split accidental from note
     * - Don't split after Mensuration Sign
     * - Don't split after Proportion sign
     * --- Because of second event 
     *     (since the connection between 1st &amp; 2nd is important, check only first item in choices)
     * - Don't split a fermata from its note
     * - Don't split a dot of augmentation from its note
     * 
     * But we need to get these items recursively for dealing with nested variants
     */

    var first = getFirstDefaultNonChoice(nGram[0]);
    var second = getFirstDefaultNonChoice(nGram[1]);

    if(first)
    {
      switch(first.objType)
      {
        case "Clef":
        case "SolmizationSign":
        case "StackedProportionSigns":
        case "ProportionSign":
          splitNow = true;
          break;
        case "MensuralSignature":
          splitNow = true;
          break;
        default:
          splitNow = false;
          break;
      }
    }

    if(second)
    {
      switch(second.objType)
      {
        case "Dot":
          // check if augments
          if(second.augments)
          {
            splitNow = true;
          }
          break;
        case "Fermata":
          // check if lengthens
          if(second.lengthens)
          {
            splitNow = true;
          }
          break;
        case "SignumCongruentiae":
          // check if effects
          if(second.effects)
          {
            splitNow = true;
          }
          break;
        default:
          // don't do anything you stupid!
          //splitNow = false;
          break;
      }
    }

    return splitNow;
  }

  /**
   * @memberof music-container
   * Gets the first non-choice default event inside a choice
   * @param {*} event Musical event
   * @returns {*} Musical event
   */
  function getFirstDefaultNonChoice(event)
  {
    do{
      event = getDefaultReading(event);
      if(Array.isArray(event))
      {
        event = event[0];
      }
    }
    while(event &amp;&amp; event.objType==="MusicalChoice");

    return event;
  }</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Thu Dec 17 2020 11:18:15 GMT+0100 (GMT+01:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
